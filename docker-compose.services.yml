# Compose file to run local DB/services used by LightRAG for development.
# Each service maps container ports to host ports so they are reachable from the host.
# Containers get an extra host entry so they can reach the host's Ollama daemon at
# `host.docker.internal` (resolves to the Docker host via host-gateway).

services:

  lightrag:
    container_name: lightrag
    image: ghcr.io/hkuds/lightrag:latest
    build:
      context: .
      dockerfile: Dockerfile
      tags:
        - ghcr.io/hkuds/lightrag:latest
    ports:
      - "${PORT:-9621}:9621"
    volumes:
      - ./data/rag_storage:/app/data/rag_storage
      - ./data/inputs:/app/data/inputs
      - ./config.ini:/app/config.ini
      - ./.env:/app/.env
    env_file:
      - .env
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ollama.host:host-gateway"
      - "docker.host:172.17.0.1"
    network_mode: host
    depends_on:
      - neo4j
      - mongodb
      - redis
      - memgraph
      - postgres

  neo4j:
    image: neo4j:5
    container_name: lightrag_neo4j
    ports:
      - "7474:7474"   # HTTP
      - "7687:7687"   # BOLT
    environment:
      - NEO4J_AUTH=neo4j/password123
    volumes:
      - neo4j_data:/data
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ollama.host:host-gateway"
      - "docker.host:172.17.0.1"

  mongodb:
    image: mongo:6
    container_name: lightrag_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ollama.host:host-gateway"
      - "docker.host:172.17.0.1"

  redis:
    image: redis:7
    container_name: lightrag_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ollama.host:host-gateway"
      - "docker.host:172.17.0.1"

  memgraph:
    image: memgraph/memgraph:latest
    container_name: lightrag_memgraph
    # Memgraph listens on 7687 (Bolt) and provides Memgraph Lab on 3000.
    # Neo4j also uses 7687; to avoid host port conflicts we map Memgraph's bolt
    # to a different host port (7688) while keeping the container port at 7687.
    ports:
      - "7688:7687"  # host 7688 -> container 7687 (Bolt)
      - "3001:3000"  # Memgraph Lab (host 3001 -> container 3000)
    volumes:
      - memgraph_data:/var/lib/memgraph
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ollama.host:host-gateway"
      - "docker.host:172.17.0.1"

  postgres:
    image: pgvector/pgvector:pg15
    container_name: lightrag_postgres
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=lightrag
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "ollama.host:host-gateway"
      - "docker.host:172.17.0.1"

volumes:
  neo4j_data: {}
  mongo_data: {}
  redis_data: {}
  memgraph_data: {}
  postgres_data: {}

# Notes:
# - Containers can reach the host's services (like Ollama) via the hostname
#   `host.docker.internal` because of the `extra_hosts` entries using
#   the `host-gateway` placeholder. This requires a recent Docker engine.
# - If your Docker version doesn't support host-gateway, either set a manual
#   IP for your host or consider starting containers with `network_mode: host`.
# - Ports exposed above map container service ports to the host so the host
#   (and other host processes like Ollama) can directly connect to these
#   services and so you can connect from tools on your workstation.
